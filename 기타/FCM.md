## FCM

FCM(Firebase Cloud Messaging)은 Firebase의 메시지 전송 플랫폼이다.

무료임과 더불어.. FCM서버를 이용하기 때문에 (앱서버를 제외하면) 서버리스 아키텍쳐를 구축한다고 볼 수 있다.

프로젝트에서 App에 알림을 보내는 기능을 구현하게 될 것 같아 공부를 해보기로 했다.

<br>

## 왜 FCM을 사용할까?

생각보다 FCM은 자료도 많고 인기도 굉장히 많았다.

장점도 많았다.

서로 다른 플랫폼 환경에서 Push알림을 구현하기 위해 따로따로 개발할 필요가 없다.

+++

<br>

## FCM의 메시지 타입

FCM이 클라이언트에게 보내는 메시지 타입은 알림 메시지와 데이터 메시지 2가지로 분류할 수 있다.

혼용해서 사용한다고 한다. 예를들어,

푸시 알림은 알림 메시지로, 푸시 알림을 눌렀을 때 나타나는 이벤트는 데이터 메시지를 통하여 이루어진다.

<br>

## FCM의 메시지 전송 방식

대상수를 기준으로 나누어진다고 볼 수 있다.

1. 단일 기기 : 1개 대상

2. 기기 그룹 : 20개 대상

3. 주제 구독 : 1000개 대상

그럼 5만명한테 메시지를 보내면 1000개씩 끊어서 50번 보내는건가?

<br>

## FCM의 동작 원리

FCM은 크게 송신자, FCM, 수신자로 구성되어 있다.

송신자는 앱서버, 수신자는 클라이언트(앱)이라고 생각하면 된다.

그럼 이제 앱에 푸시알림이 가기까지 어떤 일이 일어나는지 아주 간단하게 알아보자.

1. 먼저 앱 서버는 클라이언트에게 메시지를 보내기 위해 FCM서버에게 요청(POST)한다.

2. FCM서버는 앱 서버가 보낸 정보를 바탕으로 일치하는 클라이언트에게 메시지를 보낸다.

3. 클라이언트는 FCM서버로부터 메시지를 받아 알림이 뜨게 된다.

이 플로우 대로 메시지를 작동하려면 반드시 선행되어야 하는 작업이 있다.

FCM서버가 앱서버가 준 정보를 바탕으로 클라이언트를 식별해야함으로 클라이언트의 정보가 FCM서버에 등록되어 있어야 하며 앱서버는 이 정보를 흭득해야 한다.

<br>

## 앱 서버의 조건

FCM서버에 요청을 보내기 위한 앱서버는 다음과 같은 조건을 충족해야만 한다.

1. FCM서버에 FCM에서 지정한 형식의 메시지 요청을 보낼수 있어야 한다.

2. 지수 백오프를 이용하여 요청을 처리하고 재전송할 수 있어야 한다.

  * 지수 백오프 : 요청이 실패할때마다 다음 요청까지의 지연시간을 n배씩 늘려가며 재요청을 지연시키는 알고리즘이다
  
3. 

## 앱 서버는 어떻게 FCM서버에게 메시지를 보낼까?

공식문서에 3가지 방법이 적혀있었다.

1. Firebase admin SDK를 이용한다.

  * 공식문서에 소스코드가 상세히 적혀있어 이것도 괜찮아 보인다.

2. HTTP v1 API를 이용한다.

  * 기존의 HTTP API보다 보안이 잘되어 있음, OAuth2.0 보안 모델에 따라 수명이 짧은 엑세스토큰을 사용한다고 한다.
  
  * 공식문서에서는 이 방법을 추천하고 있었다.

3. 기존 HTTP API를 이용한다.

## FCM서버는 어떻게 클라이언트에게 메시지를 보낼까?
